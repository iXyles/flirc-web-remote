@using Web.Dashboard.Components.Dialogs
@using Web.Dashboard.Models
@using Web.Dashboard.Services

@inherits LayoutComponentBase
@implements IDisposable

@inject FlircDeviceManager DeviceManager
@inject ConfigurationService ConfigService
@inject UiConfigurationService UiConfigService
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<MudThemeProvider />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>
    <MudAppBar>
        Flirc Remote Web Interface
        <MudSpacer />
        @if (UiConfigService.IsEditModeActive)
        {
            <MudChip T="string" Color="Color.Info" Icon="@Icons.Material.Filled.Edit">EDIT MODE</MudChip>
        }
        @if (!DeviceManager.IsConnected)
        {
            <MudChip T="string" Color="Color.Error" Icon="@Icons.Material.Filled.UsbOff">DEVICE NOT CONNECTED</MudChip>
        }
        else if (DeviceManager.CurrentMode == DeviceMode.ConfigMode)
        {
            <MudChip T="string" Color="Color.Warning" Icon="@Icons.Material.Filled.Settings">CONFIGURATION MODE ACTIVE</MudChip>
        }
        else
        {
            <MudChip T="string" Color="Color.Success" Icon="@Icons.Material.Filled.CheckCircle">READY</MudChip>
        }
        <MudMenu Icon="@Icons.Material.Filled.MoreVert" AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight" IconColor="Color.Inherit" Color="Color.Inherit">
            <MudMenuItem OnClick="@ToggleEditMode" Icon="@(UiConfigService.IsEditModeActive ? Icons.Material.Filled.EditOff : Icons.Material.Filled.Edit)">
                @(UiConfigService.IsEditModeActive ? "Disable Edit Mode" : "Enable Edit Mode")
            </MudMenuItem>
            @if (UiConfigService.IsEditModeActive)
            {
                <MudMenuItem OnClick="@AddNewRemote" Icon="@Icons.Material.Filled.Add">
                    Add Remote
                </MudMenuItem>
            }
        </MudMenu>
    </MudAppBar>
    <MudMainContent>
        @Body
    </MudMainContent>
</MudLayout>

@code {
    protected override void OnInitialized()
    {
        DeviceManager.OnConnectionChanged += HandleStateChanged;
        DeviceManager.OnModeChanged += HandleStateChanged;
        ConfigService.OnConfigurationModeChanged += HandleConfigModeChanged;
        UiConfigService.OnEditModeChanged += HandleStateChanged;
    }

    private void HandleStateChanged(object? sender, EventArgs e) =>
        InvokeAsync(StateHasChanged);

    private void ToggleEditMode()
    {
        UiConfigService.ToggleEditMode();
        var message = UiConfigService.IsEditModeActive
            ? "Edit mode enabled. You can now add, rename, and remove remotes and buttons."
            : "Edit mode disabled.";
        Snackbar.Add(message, UiConfigService.IsEditModeActive ? Severity.Info : Severity.Normal, config =>
        {
            config.VisibleStateDuration = 3000;
        });
    }

    private void HandleConfigModeChanged(object? sender, ConfigurationModeChangedEventArgs e)
    {
        if (e.IsActive)
        {
            Snackbar.Add("Configuration mode activated. End-users cannot transmit signals.", Severity.Info, config =>
            {
                config.VisibleStateDuration = 3000;
            });
        }
        else
        {
            Snackbar.Add("Configuration mode ended. Device is ready for use.", Severity.Success, config =>
            {
                config.VisibleStateDuration = 3000;
            });
        }

        InvokeAsync(StateHasChanged);
    }

    private async Task AddNewRemote()
    {
        var options = new DialogOptions { CloseOnEscapeKey = true };
        await DialogService.ShowAsync<AddRemoteDialog>("Add Remote", options);
        await InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        DeviceManager.OnConnectionChanged -= HandleStateChanged;
        DeviceManager.OnModeChanged -= HandleStateChanged;
        ConfigService.OnConfigurationModeChanged -= HandleConfigModeChanged;
        UiConfigService.OnEditModeChanged -= HandleStateChanged;
    }
}
