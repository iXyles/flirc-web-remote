@using Web.Dashboard.Components.Dialogs
@using Web.Dashboard.Models
@using Web.Dashboard.Services

@inherits LayoutComponentBase
@implements IDisposable

@inject FlircDeviceManager DeviceManager
@inject ConfigurationService ConfigService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject NavigationManager Navigation

<MudThemeProvider />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>
    <MudAppBar>
        Flirc Remote Web Interface
        <MudSpacer />
        @if (!DeviceManager.IsConnected)
        {
            <MudChip T="string" Color="Color.Error" Icon="@Icons.Material.Filled.UsbOff">DEVICE NOT CONNECTED</MudChip>
        }
        else if (DeviceManager.CurrentMode == DeviceMode.ConfigMode)
        {
            <MudChip T="string" Color="Color.Warning" Icon="@Icons.Material.Filled.Settings">CONFIGURATION MODE ACTIVE</MudChip>
        }
        else
        {
            <MudChip T="string" Color="Color.Success" Icon="@Icons.Material.Filled.CheckCircle">READY</MudChip>
        }
        <MudMenu Icon="@Icons.Material.Filled.MoreVert" AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight" IconColor="Color.Inherit" Color="Color.Inherit">
            <MudMenuItem OnClick="@(() => Navigation.NavigateTo("/remote-designer"))" Icon="@Icons.Material.Filled.Edit">
                Designer
            </MudMenuItem>
            <MudMenuItem OnClick="@(() => Navigation.NavigateTo("/remote-view"))" Icon="@Icons.Material.Filled.Visibility">
                Remote View
            </MudMenuItem>
        </MudMenu>
    </MudAppBar>
    <MudMainContent>
        @Body
    </MudMainContent>
</MudLayout>

@code {
    protected override void OnInitialized()
    {
        DeviceManager.OnConnectionChanged += HandleStateChanged;
        DeviceManager.OnModeChanged += HandleStateChanged;
        ConfigService.OnConfigurationModeChanged += HandleConfigModeChanged;
    }

    private void HandleStateChanged(object? sender, EventArgs e) =>
        InvokeAsync(StateHasChanged);

    private void HandleConfigModeChanged(object? sender, ConfigurationModeChangedEventArgs e)
    {
        if (e.IsActive)
        {
            Snackbar.Add("Configuration mode activated. End-users cannot transmit signals.", Severity.Info, config =>
            {
                config.VisibleStateDuration = 3000;
            });
        }
        else
        {
            Snackbar.Add("Configuration mode ended. Device is ready for use.", Severity.Success, config =>
            {
                config.VisibleStateDuration = 3000;
            });
        }

        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        DeviceManager.OnConnectionChanged -= HandleStateChanged;
        DeviceManager.OnModeChanged -= HandleStateChanged;
        ConfigService.OnConfigurationModeChanged -= HandleConfigModeChanged;
    }
}
