@using Web.Dashboard.Components.Dialogs
@using Web.Dashboard.Models
@using Web.Dashboard.Services

@inherits LayoutComponentBase
@implements IDisposable

@inject FlircDeviceManager DeviceManager
@inject ConfigurationService ConfigService
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<MudThemeProvider />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>
    <MudAppBar>
        Remote App
        <MudSpacer />
        <MudButton OnClick="@AddNewRemote" Variant="Variant.Filled" Color="Color.Secondary" StartIcon="@Icons.Material.Filled.Add" Class="ml-2">
            ADD NEW REMOTE
        </MudButton>
        @if (!DeviceManager.IsConnected)
        {
            <MudChip T="string" Color="Color.Error" Icon="@Icons.Material.Filled.UsbOff">DEVICE NOT CONNECTED</MudChip>
        }
        else if (DeviceManager.CurrentMode == DeviceMode.ConfigMode)
        {
            <MudChip T="string" Color="Color.Warning" Icon="@Icons.Material.Filled.Settings">CONFIGURATION MODE ACTIVE</MudChip>
        }
        else
        {
            <MudChip T="string" Color="Color.Success" Icon="@Icons.Material.Filled.CheckCircle">READY</MudChip>
        }
    </MudAppBar>
    <MudMainContent>
        @Body
    </MudMainContent>
</MudLayout>

@code {
    protected override void OnInitialized()
    {
        DeviceManager.OnConnectionChanged += HandleStateChanged;
        DeviceManager.OnModeChanged += HandleStateChanged;
        ConfigService.OnConfigurationModeChanged += HandleConfigModeChanged;
    }

    private void HandleStateChanged(object? sender, EventArgs e) =>
        InvokeAsync(StateHasChanged);

    private void HandleConfigModeChanged(object? sender, ConfigurationModeChangedEventArgs e)
    {
        if (e.IsActive)
        {
            Snackbar.Add("Configuration mode activated. End-users cannot transmit signals.", Severity.Info, config =>
            {
                config.VisibleStateDuration = 3000;
            });
        }
        else
        {
            Snackbar.Add("Configuration mode ended. Device is ready for use.", Severity.Success, config =>
            {
                config.VisibleStateDuration = 3000;
            });
        }

        InvokeAsync(StateHasChanged);
    }

    private async Task AddNewRemote()
    {
        var options = new DialogOptions { CloseOnEscapeKey = true };
        await DialogService.ShowAsync<AddRemoteDialog>("Add virtual remote..", options);
        await InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        DeviceManager.OnConnectionChanged -= HandleStateChanged;
        DeviceManager.OnModeChanged -= HandleStateChanged;
        ConfigService.OnConfigurationModeChanged -= HandleConfigModeChanged;
    }
}
