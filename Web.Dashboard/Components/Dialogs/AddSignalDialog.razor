@using System.Text
@using FlircWrapper
@using Web.Dashboard.Models
@using Web.Dashboard.Services

@inject MappingService MappingService
@inject FlircService FlircService
@inject ISnackbar Snackbar

@implements IDisposable

<MudDialog>
    <DialogContent>
        <div class="d-flex justify-center flex-column">
            @if (_foundProt == null)
            {
                <MudProgressCircular Color="Color.Info" Indeterminate="true" Size="Size.Large" Style="margin: 0 auto" />
                <MudText Typo="Typo.body1" Class="mt-4">
                    PRESS REMOTE BUTTON...
                </MudText>
            }
            else
            {
                <MudText Typo="Typo.body1">
                    REMOTE BUTTON RECORDED
                </MudText>
                <MudTextField
                    T="string"
                    @bind-Value="_name"
                    Immediate="true"
                    OnKeyDown="@Callback"
                    Label="Key name"
                    Variant="Variant.Outlined"
                    Margin="Margin.Dense"
                />
                <MudField Label="Buffer" Variant="Variant.Outlined" Margin="Margin.Dense">
                    @GetBufValue(_foundProt.Value)
                </MudField>
            }
        </div>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@Fail">Cancel</MudButton>
        <MudButton OnClick="@Submit" Disabled="BeDisabled">Add</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    IMudDialogInstance MudDialog { get; set; } = null!;

    [EditorRequired, Parameter]
    public string RemoteName { get; set; } = null!;

    private CancellationTokenSource? _cancellation;
    private Task<OperationResult<IrProt>>? _result;
    private IrProt? _foundProt;
    private string _name = string.Empty;

    private bool BeDisabled => _foundProt == null || string.IsNullOrWhiteSpace(_name);

    protected override void OnInitialized()
    {
        if (!FlircService.IsConnected)
        {
            Snackbar.Add("Device not connected...", Severity.Error);
            Fail();
            return;
        }

        if (FlircService.IsScanning)
        {
            Snackbar.Add("Someone else is currently adding a new key...", Severity.Error);
            Fail();
            return;
        }

        _cancellation = new CancellationTokenSource();
        HandleTaskCompletion(FlircService.StartPoll(_cancellation.Token));
    }

    private void HandleTaskCompletion(Task<OperationResult<IrProt>> pollingTask)
    {
        pollingTask.ContinueWith(async t =>
        {
            if (t.IsFaulted)
            {
                Fail();
                Snackbar.Add(t.Exception.Message, Severity.Error);
            }
            else if (t.IsCompletedSuccessfully)
            {
                // Handle successful completion
                var result = t.Result;
                if (!result.TryGetResult(out var prot))
                {
                    Fail();
                    Snackbar.Add(string.Join(Environment.NewLine, result.ErrorMessages), Severity.Error);
                }

                _foundProt = prot;
                await InvokeAsync(StateHasChanged);
            }
        });
    }

    private void Callback(KeyboardEventArgs args)
    {
        if (args.Key == "Enter" && !BeDisabled)
            Submit();
    }

    private void Submit()
    {
        if (!_foundProt.HasValue)
        {
            Snackbar.Add("Cannot add if no signal has been registered", Severity.Error);
            return;
        }

        // Create a new buffer of the correct length and convert to short[]
        var buf = _foundProt.Value.buf
            .Take(_foundProt.Value.len)
            .Select(b => unchecked((short)b))
            .ToArray();

        var result = MappingService.AddMapping(RemoteName, new MappedIr(_name, buf));

        if (result.IsSuccess())
        {
            Snackbar.Add("Mapped signal added!", Severity.Success);
            Success();
        }
        else
        {
            Snackbar.Add(string.Join(Environment.NewLine, result.ErrorMessages), Severity.Error);
        }
    }

    private static string GetBufValue(IrProt packet)
    {
        var value = new StringBuilder();
        for (var i = 0; i < packet.len && i < packet.buf.Length; i++)
        {
            value.Append($"{packet.buf[i]} ");
        }

        return value.ToString();
    }

    void Success() => InvokeAsync(() => MudDialog.Close(DialogResult.Ok(true)));
    void Fail() => InvokeAsync(() => MudDialog.Cancel());

    public void Dispose()
    {
        if (_cancellation != null && _result != null)
        {
            _cancellation.Cancel();
            _cancellation = null;
            _result = null;
        }
    }
}
