@page "/remote/{RemoteName}"

@using Web.Dashboard.Components.Dialogs
@using Web.Dashboard.Models
@using Web.Dashboard.Services

@inject IDialogService DialogService
@inject MappingService MappingService
@inject FlircService FlircService
@inject FlircDeviceManager DeviceManager
@inject UiConfigurationService UiConfigService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation

@implements IDisposable

<MudContainer Class="mt-6" MaxWidth="MaxWidth.False">
    <MudButton Variant="Variant.Outlined" OnClick="@GoBack" StartIcon="@Icons.Material.Filled.ArrowBack">Back to Remotes</MudButton>

    @if (DeviceManager.CurrentMode == DeviceMode.ConfigMode)
    {
        <MudAlert Severity="Severity.Warning" Class="my-4" Icon="@Icons.Material.Filled.Settings">
            <strong>Configuration Mode Active</strong><br />
            The device is currently in configuration mode. Please wait for the other user to finish configuring before using the remote.
        </MudAlert>
    }

    <MudText Typo="Typo.h4" Class="mt-4 mb-2">@RemoteName</MudText>

    <MudGrid>
        @{
            var mappings = MappingService.GetRemoteMappings(RemoteName).ToList();
        }
        @if (mappings.Count == 0 && !UiConfigService.IsEditModeActive)
        {
            <MudItem xs="12">
                <MudAlert Severity="Severity.Info">
                    This remote has no buttons. Enable edit mode to add buttons.
                </MudAlert>
            </MudItem>
        }
        @foreach (var mapped in mappings)
        {
            <MudItem xs="12" sm="6" md="4" lg="3">
                <MudPaper Elevation="2" Class="pa-4 d-flex flex-column" Style="height: 200px; position: relative;">
                    @if (UiConfigService.IsEditModeActive)
                    {
                        <div style="position: absolute; top: 4px; right: 4px; z-index: 10;">
                            <MudMenu Icon="@Icons.Material.Filled.MoreVert" Size="Size.Small" AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight" Dense="true">
                                <MudMenuItem OnClick="@(() => RenameButton(mapped.Name))" Icon="@Icons.Material.Filled.Edit">
                                    Rename Button
                                </MudMenuItem>
                                <MudMenuItem OnClick="@(() => RemoveButton(mapped.Name))" Icon="@Icons.Material.Filled.Delete">
                                    Remove Button
                                </MudMenuItem>
                            </MudMenu>
                        </div>
                    }
                    <MudButton
                        Style="height: 100%"
                        OnClick="@(() => SendSignal(mapped))"
                        FullWidth="true"
                        Variant="Variant.Filled"
                        Color="Color.Primary"
                        DropShadow="false"
                        Disabled="@(DeviceManager.CurrentMode == DeviceMode.ConfigMode || !DeviceManager.IsConnected)">
                        @mapped.Name
                    </MudButton>
                </MudPaper>
            </MudItem>
        }
        @if (UiConfigService.IsEditModeActive)
        {
            <MudItem xs="12" sm="6" md="4" lg="3">
                <MudPaper Elevation="2" Class="pa-4 d-flex flex-column" Style="height: 200px">
                    <MudButton
                        Style="height: 100%"
                        OnClick="@RecordButton"
                        FullWidth="true"
                        Variant="Variant.Outlined"
                        Color="Color.Primary"
                        DropShadow="false"
                        StartIcon="@Icons.Material.Filled.Add">
                        RECORD BUTTON
                    </MudButton>
                </MudPaper>
            </MudItem>
        }
    </MudGrid>
</MudContainer>

@code {
    [Parameter]
    public string? RemoteName { get; set; }

    protected override void OnInitialized()
    {
        if (string.IsNullOrWhiteSpace(RemoteName))
        {
            GoBack();
            return;
        }

        MappingService.OnChange += MappingServiceOnOnChange;
        FlircService.OnTransmitResult += FlircServiceOnOnTransmitResult;
        DeviceManager.OnModeChanged += HandleDeviceStateChanged;
        DeviceManager.OnConnectionChanged += HandleDeviceStateChanged;
        UiConfigService.OnEditModeChanged += HandleDeviceStateChanged;
    }

    private void HandleDeviceStateChanged(object? sender, EventArgs e) =>
        InvokeAsync(StateHasChanged);

    private void FlircServiceOnOnTransmitResult(object? sender, OperationResultEventArgs e)
    {
        if (!e.OperationResult.IsSuccess())
        {
            Snackbar.Add(
                $"Failed to transmit button: {string.Join(Environment.NewLine, e.OperationResult.ErrorMessages)}",
                Severity.Error,
                opt =>
                {
                    opt.VisibleStateDuration = 1000;
                },
                "transmit"
            );
        }
    }

    private void MappingServiceOnOnChange(object? sender, EventArgs e)
    {
        InvokeAsync(StateHasChanged);
    }

    private async Task RecordButton()
    {
        var options = new DialogOptions { CloseOnEscapeKey = true };
        var parameters = new DialogParameters
        {
            { nameof(AddSignalDialog.RemoteName), RemoteName }
        };
        await DialogService.ShowAsync<AddSignalDialog>("Record Button", parameters, options);
    }

    private async Task RenameButton(string buttonName)
    {
        var options = new DialogOptions { CloseOnEscapeKey = true };
        var parameters = new DialogParameters
        {
            { nameof(RenameButtonDialog.RemoteName), RemoteName },
            { nameof(RenameButtonDialog.CurrentButtonName), buttonName }
        };
        await DialogService.ShowAsync<RenameButtonDialog>("Rename Button", parameters, options);
    }

    private async Task RemoveButton(string buttonName)
    {
        var options = new DialogOptions { CloseOnEscapeKey = true };
        var parameters = new DialogParameters<QuestionDialog>
        {
            { x => x.Text, $"Do you really want to delete the button '{buttonName}'? This process cannot be undone." },
            { x => x.Title, "Remove Button?" },
            { x => x.OkAction, () => MappingService.RemoveRemoteMapping(RemoteName!, buttonName) }
        };

        await DialogService.ShowAsync<QuestionDialog>("Remove Button", parameters, options);
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/");
    }

    private void SendSignal(MappedIr mapped)
    {
        var result = FlircService.QueueTransmit(mapped);
        if (!result.IsSuccess())
        {
            Snackbar.Add(
                string.Join(Environment.NewLine, result.ErrorMessages),
                Severity.Error,
                opt =>
                {
                    opt.VisibleStateDuration = 3000;
                },
                "transmit"
            );
        }
    }

    public void Dispose()
    {
        MappingService.OnChange -= MappingServiceOnOnChange;
        FlircService.OnTransmitResult -= FlircServiceOnOnTransmitResult;
        DeviceManager.OnModeChanged -= HandleDeviceStateChanged;
        DeviceManager.OnConnectionChanged -= HandleDeviceStateChanged;
        UiConfigService.OnEditModeChanged -= HandleDeviceStateChanged;
    }
}
